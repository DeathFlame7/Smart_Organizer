# 拖放管理器模块技术文档

## 1. 模块概述

拖放管理器（DragManager）模块实现了智能文件管理助手二级界面中三个主要区域（目录/文件树、分类预览/处理结果、操作日志）的位置拖放功能。用户可以通过拖动这些区域来重新排列它们的位置，提高工作效率和个性化体验。

## 2. 核心功能

- **区域拖放**：支持三个主要区域的自由拖动和位置更换
- **网格对齐**：拖动时显示半透明网格，帮助精确定位
- **视觉反馈**：拖动时虚化其他非拖动区域，突出当前操作对象
- **智能重叠处理**：自动处理区域重叠情况，移动被覆盖的区域
- **边界限制**：确保拖动区域限制在窗口内除标题栏和按钮区域之外

## 3. 模块结构

- `gui/drag_manager/` - 拖放管理器模块目录
  - `__init__.py` - 模块初始化文件
  - `drag_manager.py` - 拖放管理器核心实现
  - `技术文档_drag_manager模块.md` - 技术文档

## 4. 核心类详解

### 4.1 DragManager 类

这是模块的核心类，负责处理所有拖放相关的逻辑。

#### 4.1.1 主要属性

- `main_window` - 主窗口引用
- `dragging_widget` - 当前正在拖动的部件
- `drag_start_pos` - 拖动开始位置
- `drag_offset` - 拖动偏移量
- `rubber_band` - 拖动时显示的橡皮筋框
- `grid_size` - 网格大小（默认为20像素）
- `draggable_widgets` - 可拖动部件列表

#### 4.1.2 主要方法

- `setup_draggable_widgets()` - 设置可拖动的窗口部件并安装事件过滤器
- `eventFilter(source, event)` - 捕获鼠标事件，判断是否开始拖动
- `start_drag(widget, position)` - 开始拖动操作，显示网格和橡皮筋框
- `mouseMoveEvent(event)` - 处理鼠标移动，更新拖动位置并对齐到网格
- `mouseReleaseEvent(event)` - 结束拖动操作，处理最终位置和重叠
- `handle_overlaps(new_rect)` - 处理区域重叠，自动移动被覆盖的部件
- `adjust_layout()` - 调整整体布局结构
- `paintEvent(event)` - 绘制半透明网格和虚化效果
- `resizeEvent(event)` - 跟随主窗口调整大小

## 5. 实现原理

### 5.1 拖放机制

1. **事件捕获**：通过事件过滤器捕获可拖动区域的鼠标按下事件
2. **位置跟踪**：记录拖动开始位置和偏移量
3. **视觉反馈**：显示橡皮筋框和半透明网格
4. **边界检查**：确保拖动不超出有效区域
5. **重叠处理**：检测并自动移动重叠的区域

### 5.2 关键技术点

- 使用 `QRubberBand` 实现拖动预览
- 通过 `QPainter` 绘制半透明网格和虚化效果
- 使用事件过滤器机制捕获鼠标事件
- 实现网格对齐算法确保精确定位
- 设计重叠检测和处理算法

## 6. 使用指南

### 6.1 启动方式

拖放管理器会在程序启动时自动初始化，无需额外操作。

### 6.2 使用方法

1. **开始拖动**：将鼠标移动到区域的标题栏上，按下左键并开始拖动
2. **调整位置**：拖动时会显示半透明网格，帮助定位
3. **释放放置**：释放鼠标左键，区域将被放置在新位置
4. **自动调整**：如有重叠区域，系统会自动移动被覆盖的区域

### 6.3 注意事项

- 只能通过区域的标题栏拖动（例如"目录"、"分类预览/处理结果"、"操作日志"）
- 拖动区域会自动对齐到20x20的网格
- 拖动时其他区域会被虚化，突出显示当前操作的区域
- 拖动范围限制在窗口内除标题栏和按钮外的区域

## 7. 配置与依赖

### 7.1 依赖项

- PySide6 - 用于GUI组件和事件处理

### 7.2 配置选项

可以通过修改 `drag_manager.py` 中的以下参数来调整行为：
- `grid_size` - 网格大小（默认为20像素）
- `overlap_threshold` - 重叠阈值（默认为0.5，表示超过50%的重叠才会触发自动移动）
- `title_bar_height` - 标题栏高度估计值（默认为40像素）

## 8. 已知问题与解决方案

| 问题 | 解决方案 |
|------|---------|
| 区域可能被拖到窗口边缘外 | 通过边界检查确保区域始终在有效范围内 |
| 拖动时性能下降 | 使用轻量级的绘制方法，只在必要时更新UI |
| 复杂布局下可能出现异常 | 提供adjust_layout()方法以便根据需要自定义布局调整 |

## 9. 扩展建议

- 实现区域的旋转功能
- 添加保存/恢复布局功能
- 提供自定义网格大小的设置选项
- 实现多列布局支持
- 添加拖动时的动画效果

## 10. 更新日志

### 版本 1.0.0
- 初始实现，支持三个主要区域的拖放功能
- 实现网格对齐和重叠自动处理
- 添加半透明网格和区域虚化效果